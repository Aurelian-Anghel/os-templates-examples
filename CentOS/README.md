# Building a MetalSoft CentOS unattended install template

To create an unattended install based local template use the script provided:

```bash
bash ./create_centos_8_template.sh centos-8 8
```

or

```bash
bash ./create_centos_8_2_2004_template.sh centos-8-2-2004 8.2.2004
```

The first param is the label of the template and the second must match the name of the directory under CentOS/ directory.

The script can be executed multiple times, the template will be deleted if it exists.

If you want to alter the installation we recommend starting by copying the `8` or `8.2.2004` directory and editing the `ks.conf`.  The variable glossary is available [in the documentation](https://docs.metalsoft.io/en/latest/guides/creating_a_local_install_template_from_scratch.html).

## How this works

The provisioning steps followed by the system are as follows:
1. a NIC connected to the quarantine network performs a PXE boot (issues a DHCP request and receives a reply with tftp:///BOOTX64.EFI as a first stage bootloader). This bootloader is required for secure boot.
2. BOOTX64.EFI then downloads grubx64.efi over TFTP and boots it
3. GRUB then downloads the grub configuration file tftp:///grub.conf (template is called grubx64.cfg)
4. GRUB then (based on what is written in grub.cfg) will pull /vmlinuz (the linux kernel) and /initrd.img (the initial ramdisk) binary files over TFTP over the quarantine network
5. The linux kernel and initrd now boot and will execute various initialization routines based on the linux command line (the vmlinuz params in grub.cfg). Note the variables used. They will be replaced at runtime automatically by the system with the appropriate values when the file is served via TFTP or HTTP. Important parameters are:
    1. `ifname=wan:{{wan_interface_mac_address_0}} ip=wan:dhcp` - these tell the initrd to only perform DHCP on the WAN interface. This is important as the quarantine network will conflict with the WAN.  A WAN network will be provisioned during install even none is defined by the user in the infrastructure editor to allow the installer to reach additional repositories and pull updates.
    2. `inst.repo={{repo_url_root}}/centos/8.2.2004/BaseOS/x86_64/kickstart` and `inst.stage2={{repo_url_root}}/centos/8.2.2004/BaseOS/x86_64/kickstart` - this specify the repository for this particular linux version
    3. `inst.noninteractive inst.text` - this instructs the installer to be fully non-interactive
    4. `inst.ks={{HTTP_SERVER_ENDPOINT}}/ks.cfg` - this tells the installer where the kickstart file (that defines what gets installed can be found. In this case the file will be pulled over HTTP from the datacenter agent (it is an asset).
6. The installer (anaconda) will then start and pull the kickstart file from HTTP and will interpret it and based on it will perform the deploy. Please note that the kernel command line options take precedence over kickstart options. Important configuration aspects: in the kickstart are:
 the WAN configuration, the SNMP configuration that is pulled over HTTP as it is an asset.
    1. `rootpw --plaintext {{initial_password}}` this instructs MetalSoft to use the password provided by the template. This can either be a static password or an automatically generated password. We use the automatically generated password in this case (note the `--use-autogenerated-initial-password` param to the `os-template create` command in the `create_centos_8_template.sh` file).  At the end of the provisioning the system will cycle and wait for a successful SSH connection to verify that the setup was finished by using either the root password configured on the template or the automatically generated SSH keys.
    2. `network  --bootproto=dhcp --device={{wan_interface_mac_address_0}} --ipv6=auto --activate` this instructs the kickstart to configure the system to bring up the wan interface in the resulting system.
    3. `network  --hostname={{instance_subdomain_permanent}}` this configures the hostname of the system
    4. The %post section enables iptables, configures snmp (by pulling the template as an asset) and configures the ssh keys.

## Operating in environments without direct internet access

Where the internet is available only trough a proxy server (e.g. [Squid](https://en.wikipedia.org/wiki/Squid_(software))) to the instances.
Then configure the following in the postinst section of the /ks.conf asset.

```bash
%post
# Main defines all global configuration options.
echo 'proxy=http://{{datacenter_web_proxy_server_ip}}:{{datacenter_web_proxy_server_port}}' >> /etc/yum.conf
echo 'proxy_username={{datacenter_web_proxy_username}}' >> /etc/yum.conf
echo 'proxy_password={{datacenter_web_proxy_password}}' >> /etc/yum.conf

%end
```

or by repoid

```bash
%post
# Update proxy setting in repositories with repoid <repo1> and <repo2> and make the change permanent.
dnf config-manager --save --setopt=*.proxy=http://{{datacenter_web_proxy_server_ip}}:{{datacenter_web_proxy_server_port}}/ <repo1> <repo2>

%end
```

## Replace default yum repositories to private repositories

Configure the following in the postinst section of the /ks.conf asset.

```bash
%post

for REPO in $(dnf repolist enabled | tail -n +2 | awk '{ print $1 }')
do 
    dnf config-manager --set-disabled $REPO
done

function addRepo() {
        for REPO in `seq 1 $#`
        do
            REPOID=`echo "${!REPO////_}"`
            dnf config-manager --add-repo http://"${!REPO}"
            dnf config-manager --save --setopt $REPOID.gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
            dnf config-manager --save --setopt $REPOID.gpgcheck=1
        done
}

REPOHOST=`cat -d/ -f3 <<< {{repo_url_root}}`
addRepo $REPOHOST/centos/8/extras/x86_64/os/ $REPOHOST/centos/8/AppStream/x86_64/os/ $REPOHOST/centos/8/BaseOS/x86_64/os/

%end
```
